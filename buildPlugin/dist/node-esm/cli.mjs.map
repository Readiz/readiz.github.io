{"version":3,"file":"cli.mjs","sources":["../../src/node/constants.ts","../../src/node/static-site-generation/index.ts","../../src/node/cli.ts"],"sourcesContent":["import { resolve } from 'path'\r\nimport { fileURLToPath } from 'url'\r\n\r\nexport const PKG_ROOT = resolve(fileURLToPath(import.meta.url), '../../..')\r\nexport const CLIENT_PATH = resolve(PKG_ROOT, 'dist/client-bundles')\r\n","import { build as viteBuild } from 'vite'\r\nimport type { ResolvedConfig, Rollup } from 'vite'\r\nimport { minify } from 'html-minifier-terser'\r\nimport * as path from 'path'\r\nimport fs from 'fs-extra'\r\nimport { pathToFileURL } from 'node:url'\r\n\r\nimport { CLIENT_PATH } from '../constants'\r\nimport type { SSRPlugin } from '../../../clientTypes'\r\nimport type { staticSiteGenerationConfig } from '../types'\r\n\r\ntype RollupOutput = Rollup.RollupOutput\r\n\r\nconst minifyOptions = {\r\n  keepClosingSlash: true,\r\n  removeRedundantAttributes: true,\r\n  removeStyleLinkTypeAttributes: true,\r\n  useShortDoctype: true,\r\n  minifyCSS: true,\r\n}\r\n\r\nexport async function ssrBuild(\r\n  viteConfig: ResolvedConfig,\r\n  argv: any,\r\n  ssrConfig?: staticSiteGenerationConfig\r\n) {\r\n  // ssr build should not use hash router\r\n  // if (viteOptions?.define?.['__HASH_ROUTER__'])\r\n  //   viteOptions!.define!['__HASH_ROUTER__'] = false\r\n  const root = viteConfig.root\r\n  let outDir = viteConfig.build?.outDir ?? 'dist'\r\n  outDir = path.resolve(root, outDir)\r\n  await fs.emptyDir(outDir)\r\n\r\n  const ssrOutDir = path.join(outDir, 'ssr-tmp')\r\n  const clientOutDir = path.join(outDir, 'client-tmp')\r\n\r\n  console.log('\\n\\npreparing vite pages ssr bundle...')\r\n  const ssrOutput = await viteBuild({\r\n    root,\r\n    configFile: viteConfig.configFile,\r\n    // mode: \"development\",\r\n    build: {\r\n      ssr: true,\r\n      cssCodeSplit: false,\r\n      rollupOptions: {\r\n        input: path.join(CLIENT_PATH, 'entries', 'ssg-server.mjs'),\r\n        // preserveEntrySignatures: 'allow-extension',\r\n        output: {\r\n          entryFileNames: '[name].mjs',\r\n          chunkFileNames: '[name]-[hash].mjs',\r\n        },\r\n      },\r\n      outDir: ssrOutDir,\r\n      minify: false,\r\n    },\r\n    ssr: {\r\n      // `vite-pages-theme-doc/dist/index.js` have `import './index.css'`\r\n      // so it needs to be bundled by vite before executed by node.js.\r\n      // This is coupled to theme-doc,\r\n      // but we don't want to ask users to put this in their vite config.\r\n      // So let's put it here :)\r\n      noExternal: ['vite-pages-theme-doc'],\r\n    },\r\n  })\r\n\r\n  console.log('\\n\\nrendering html...')\r\n\r\n  const ssrPluginPromises: Promise<SSRPlugin>[] = []\r\n  ;(global as any)['register_vite_pages_ssr_plugin'] = (\r\n    importSSRPlugin: () => Promise<SSRPlugin>\r\n  ) => {\r\n    ssrPluginPromises.push(importSSRPlugin())\r\n  }\r\n  process.env.VITE_PAGES_IS_SSR = 'true'\r\n\r\n  const { renderToString, ssrData } = await import(\r\n    pathToFileURL(path.join(ssrOutDir, 'ssg-server.mjs')).toString()\r\n  )\r\n\r\n  const ssrPlugins = await Promise.all(ssrPluginPromises)\r\n  ssrPlugins.forEach((plugin, index) => {\r\n    // validate ssr plugins\r\n    if (!plugin?.id) {\r\n      console.error('invalid ssr plugins:', ssrPlugins)\r\n      throw new Error('invalid ssr plugin: no plugin id')\r\n    }\r\n    const idx = ssrPlugins.findIndex((p) => p.id === plugin.id)\r\n    if (idx !== index) {\r\n      console.error('invalid ssr plugins:', ssrPlugins)\r\n      throw new Error(`duplicate ssr plugin: ${plugin.id}`)\r\n    }\r\n  })\r\n\r\n  const pagePaths = Object.keys(ssrData)\r\n\r\n  console.log('\\n\\npreparing vite pages client bundle...')\r\n  const _clientResult = await viteBuild({\r\n    root,\r\n    configFile: viteConfig.configFile,\r\n    build: {\r\n      cssCodeSplit: false,\r\n      rollupOptions: {\r\n        input: path.join(CLIENT_PATH, 'entries', 'ssg-client.mjs'),\r\n        preserveEntrySignatures: 'allow-extension',\r\n      },\r\n      assetsDir: 'assets',\r\n      outDir: clientOutDir,\r\n    },\r\n  })\r\n  let clientResult: RollupOutput\r\n  if (Array.isArray(_clientResult)) {\r\n    if (_clientResult.length !== 1)\r\n      throw new Error(`expect viteBuild to have only one BuildResult`)\r\n    clientResult = _clientResult[0]\r\n  } else {\r\n    clientResult = _clientResult as RollupOutput\r\n  }\r\n\r\n  const entryChunk = (() => {\r\n    const _entryChunks = clientResult.output.filter((chunkOrAsset) => {\r\n      return chunkOrAsset.type === 'chunk' && chunkOrAsset.isEntry\r\n    })\r\n    if (_entryChunks.length !== 1) {\r\n      throw new Error(`Expect one entryChunk. Got ${_entryChunks.length}.`)\r\n    }\r\n    return _entryChunks[0]\r\n  })()\r\n\r\n  const cssChunks = clientResult.output.filter((chunk) => {\r\n    return chunk.type === 'asset' && chunk.fileName.endsWith('.css')\r\n  })\r\n\r\n  const basePath = viteConfig.base ?? '/'\r\n\r\n  const htmlCode = await fs.readFile(path.join(root, 'index.html'), 'utf-8')\r\n  const RootElementInjectPoint = '<div id=\"root\"></div>'\r\n  if (!htmlCode.includes(RootElementInjectPoint)) {\r\n    throw new Error(\r\n      `Your index.html should contain the RootElementInjectPoint: \"${RootElementInjectPoint}\" (it must appear exactly as-is)`\r\n    )\r\n  }\r\n  const EntryModuleInjectPoint =\r\n    '<script type=\"module\" src=\"/@pages-infra/main.js\"></script>'\r\n  if (!htmlCode.includes(EntryModuleInjectPoint)) {\r\n    throw new Error(\r\n      `Your index.html should contain EntryModuleInjectPoint: \"${EntryModuleInjectPoint}\" (it must appear exactly as-is)`\r\n    )\r\n  }\r\n  const CSSInjectPoint = '</head>'\r\n  if (!htmlCode.includes(CSSInjectPoint)) {\r\n    throw new Error(\r\n      `Your index.html should contain CSSInjectPoint: \"${CSSInjectPoint}\" (it must appear exactly as-is)`\r\n    )\r\n  }\r\n\r\n  await Promise.all(\r\n    pagePaths.map(async (pagePath) => {\r\n      // currently not support pages with path params\r\n      // .e.g /users/:userId\r\n      if (pagePath.match(/\\/:\\w/)) return\r\n      const html = await renderHTML(pagePath)\r\n      // TODO: injectPreload\r\n      // preload data module for this page\r\n      // html = injectPreload(html, \"path/to/page/data\")\r\n      const writePath = path.join(\r\n        clientOutDir,\r\n        pagePath.replace(/^\\//, ''),\r\n        'index.html'\r\n      )\r\n      await fs.ensureDir(path.dirname(writePath))\r\n      await fs.writeFile(writePath, html)\r\n      if (pagePath !== '/') {\r\n        // should write to both /pagePath/index.html and /pagePath.html\r\n        const writePath2 = path.join(\r\n          clientOutDir,\r\n          pagePath.replace(/^\\//, '') + '.html'\r\n        )\r\n        await fs.ensureDir(path.dirname(writePath2))\r\n        await fs.writeFile(writePath2, html)\r\n      }\r\n    })\r\n  )\r\n\r\n  const html404Path = path.join(clientOutDir, '404.html')\r\n  // pass in a pagePath that won't match any defined page\r\n  // so the render result will be 404 page\r\n  const html404 = await renderHTML('/internal-404-page')\r\n  await fs.writeFile(html404Path, html404)\r\n  // move 404 page to `/` if `/` doesn't exists\r\n  if (!pagePaths.includes('/')) {\r\n    await fs.copy(html404Path, path.join(clientOutDir, 'index.html'))\r\n  }\r\n\r\n  await fs.copy(clientOutDir, outDir)\r\n  await fs.remove(clientOutDir)\r\n  await fs.remove(ssrOutDir)\r\n  console.log('vite pages ssr build finished successfully.')\r\n  return\r\n\r\n  async function renderHTML(pagePath: string) {\r\n    const { contentText, styleText } = renderToString(pagePath, ssrPlugins)\r\n    const ssrInfo = {\r\n      routePath: pagePath,\r\n    }\r\n    let html = htmlCode.replace(\r\n      RootElementInjectPoint,\r\n      // let client know the current ssr page\r\n      `<script>window._vitePagesSSR=${JSON.stringify(ssrInfo)};</script>\r\n<div id=\"root\">${contentText}</div>`\r\n    )\r\n    const cssInject = cssChunks.map((cssChunk) => {\r\n      return `<link rel=\"stylesheet\" href=\"${basePath}${cssChunk.fileName}\" />`\r\n    })\r\n    cssInject.push(styleText)\r\n\r\n    html = html.replace(\r\n      CSSInjectPoint,\r\n      `${cssInject.join('\\n')}\r\n${CSSInjectPoint}`\r\n    )\r\n    html = html.replace(\r\n      EntryModuleInjectPoint,\r\n      `<script type=\"module\" src=\"${basePath}${entryChunk.fileName}\"></script>`\r\n    )\r\n\r\n    const minifyHtml = argv?.minifyHtml ?? ssrConfig?.minifyHtml ?? true\r\n    if (minifyHtml) {\r\n      const minifiedHtml = await minify(html, minifyOptions)\r\n      return minifiedHtml\r\n    }\r\n\r\n    return html\r\n  }\r\n}\r\n\r\nconst injectPreload = (html: string, filePath: string) => {\r\n  const tag = `<link rel=\"modulepreload\" href=\"${filePath}\" />`\r\n  if (/<\\/head>/.test(html)) {\r\n    return html.replace(/<\\/head>/, `${tag}\\n</head>`)\r\n  } else {\r\n    return tag + '\\n' + html\r\n  }\r\n}\r\n","import chalk from 'chalk'\r\nimport fs from 'fs-extra'\r\nimport minimist from 'minimist'\r\nimport path from 'node:path'\r\nimport { resolveConfig } from 'vite'\r\nimport type { InlineConfig } from 'vite'\r\nimport { PKG_ROOT } from './constants'\r\nimport { ssrBuild } from './static-site-generation'\r\nimport type { staticSiteGenerationConfig } from './types'\r\n\r\nconst argv: any = minimist(process.argv.slice(2))\r\n\r\nconsole.log(\r\n  chalk.cyan(\r\n    `vite-pages v${\r\n      fs.readJSONSync(path.resolve(PKG_ROOT, 'package.json')).version\r\n    }`\r\n  )\r\n)\r\n// console.log(chalk.cyan(`vite v${require('vite/package.json').version}`))\r\n\r\n// cli usage: vite-pages ssr [root] [--minifyHtml] [vite options like: --configFile, --base, --logLevel, --mode, --build.outDir, etc.]\r\nconst [command, root] = argv._\r\nif (root) {\r\n  argv.root = root\r\n}\r\n\r\n// make `--minifyHtml=false` to be treated as boolean false instead of string \"false\"\r\nObject.entries(argv).forEach(([key, value]) => {\r\n  if (value === 'false') argv[key] = false\r\n})\r\n\r\n// console.log('@@argv', argv)\r\n;(async () => {\r\n  if (!command || command === 'ssr') {\r\n    const toBeResovledConfig: InlineConfig = {\r\n      ...argv,\r\n    }\r\n\r\n    // user can pass in vite config like --outDir or --configFile\r\n    const viteConfig = await resolveConfig(\r\n      toBeResovledConfig,\r\n      'build',\r\n      'production',\r\n      'production'\r\n    )\r\n    const thisPlugin = viteConfig.plugins.find((plugin) => {\r\n      return plugin.name === 'vite-plugin-react-pages'\r\n    })\r\n    //@ts-expect-error\r\n    const ssrConfig = thisPlugin?.vitePagesStaticSiteGeneration as\r\n      | staticSiteGenerationConfig\r\n      | undefined\r\n\r\n    await ssrBuild(viteConfig, argv, ssrConfig).catch((err: any) => {\r\n      console.error(chalk.red(`ssr error:\\n`), err)\r\n      process.exit(1)\r\n    })\r\n  } else {\r\n    console.error(\r\n      `[vite-pages] Invalid command. CLI usage: vite-pages ssr [root] [--minifyHtml] [vite options like: --configFile, --base, --logLevel, --mode, --build.outDir, etc.]`\r\n    )\r\n  }\r\n})()\r\n"],"names":["PKG_ROOT","resolve","fileURLToPath","import","meta","url","CLIENT_PATH","minifyOptions","keepClosingSlash","removeRedundantAttributes","removeStyleLinkTypeAttributes","useShortDoctype","minifyCSS","ssrBuild","viteConfig","argv","ssrConfig","root","outDir","build","path","fs","emptyDir","ssrOutDir","join","clientOutDir","console","log","viteBuild","configFile","ssr","cssCodeSplit","rollupOptions","input","output","entryFileNames","chunkFileNames","minify","noExternal","ssrPluginPromises","global","importSSRPlugin","push","process","env","VITE_PAGES_IS_SSR","renderToString","ssrData","pathToFileURL","toString","ssrPlugins","Promise","all","forEach","plugin","index","id","error","Error","idx","findIndex","p","pagePaths","Object","keys","_clientResult","preserveEntrySignatures","assetsDir","clientResult","Array","isArray","length","entryChunk","_entryChunks","filter","chunkOrAsset","type","isEntry","cssChunks","chunk","fileName","endsWith","basePath","base","htmlCode","readFile","RootElementInjectPoint","includes","EntryModuleInjectPoint","CSSInjectPoint","map","pagePath","match","html","renderHTML","writePath","replace","ensureDir","dirname","writeFile","writePath2","html404Path","html404","copy","remove","contentText","styleText","ssrInfo","routePath","JSON","stringify","cssInject","cssChunk","minifyHtml","minifiedHtml","minimist","slice","chalk","cyan","readJSONSync","version","command","_","entries","key","value","toBeResovledConfig","resolveConfig","thisPlugin","plugins","find","name","vitePagesStaticSiteGeneration","catch","err","red","exit"],"mappings":"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"}